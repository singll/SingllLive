# SingllLive 直播系统技术文档

> 程序员深夜电台 - 完全自动化的多模式直播系统

## 目录

- [一、系统概述](#一系统概述)
- [二、屏幕布局与 ABC 区域](#二屏幕布局与-abc-区域)
- [三、快速开始](#三快速开始)
- [四、配置详解](#四配置详解)
- [五、工作流程](#五工作流程)
- [六、故障排查](#六故障排查)

---

## 一、系统概述

### 1.1 核心功能

本系统是一个**完全自动化、多模式的直播系统**，使用 Python 实现，支持：

- ✓ **6种播放模式**：直播、PK、歌曲、录像、回放、空闲
- ✓ **动态 VLC 管理**：通过 OBS WebSocket 直接控制 VLC 源播放列表
- ✓ **状态保存**：模式切换时保存播放进度，切回来后从断点恢复
- ✓ **实时弹幕命令**：点歌、点播、切歌、查看歌单、模式切换等
- ✓ **智能面板**：1秒刷新率，充分利用B区520×435像素空间
- ✓ **模式系统**：直播 / PK / 歌曲 / 录像 / 回放 / 空闲，所有模式可自由切换

### 1.2 技术栈

| 组件 | 技术 | 说明 |
|------|------|------|
| **主程序** | Python 3.8+ | asyncio 异步框架 |
| **OBS 控制** | obsws-python (WebSocket v5) | 直接控制 VLC 源播放列表和源可见性 |
| **弹幕机器人** | blivedm + bilibili-api | 接收弹幕、发送回复 |
| **面板渲染** | Pillow (PIL) | 动态生成PNG，零GPU开销 |
| **直播捕获** | OBS Studio 28+ | 内置 WebSocket v5 服务器 |

### 1.3 文件结构

```
SingllLive/
├── cyber_live.py              # 主程序入口
├── config.ini                 # 配置文件（需自行编辑）
├── requirements.txt           # Python 依赖
│
├── modules/
│   ├── obs_control.py        # OBS WebSocket v5 控制器
│   ├── vlc_control.py        # VLC 源播放控制（状态保存 + 模式切换）
│   ├── modes.py              # 模式管理系统 (6种模式)
│   ├── songs.py              # 歌曲库管理
│   ├── replay.py             # 录播回放管理
│   ├── panel.py              # 面板渲染器 (6种模式)
│   ├── danmaku.py            # 弹幕机器人
│   └── brotli_patch.py       # Python 3.14 兼容性补丁
│
├── assets/
│   ├── background.png         # 背景图
│   ├── frame-overlay.png      # 框架遮罩
│   └── fonts/
│       └── JetBrainsMono-Regular.ttf
│
├── data/                       # 运行时数据（自动生成）
│   ├── panel.png              # 动态面板图片
│   └── now_playing.txt        # 当前歌名
│
└── doc/
    └── singll-live-guide.md   # 本文档
```

---

## 二、屏幕布局与 ABC 区域

### 2.1 总体布局（1920×1080）

```
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  ┏━━━━━ A 区（显示器，边框8px）━━━━━━┓  B 区         │
│  ┃                          ┃  (522×440)  │
│  ┃      屏幕区域            ┃  终端面板   │
│  ┃    1344×756 (16:9)       ┃  内容区    │
│  ┃  (VLC 视频播放)          ┃ ┌─────────┐│
│  ┃                          ┃ │ 模式    ││
│  ┃                          ┃ │ 信息    ││
│  ┗━━━━━━━━━━━━━━━━━━━━━━━━━━┛ │ 动态    ││
│  ♦♦♦♦♦♦ RGB灯条 + 底座 ♦♦♦♦  │ 面板    ││
│                               └─────────┘│
│  ───────────────────────────────────────
│                               ┌─────────┐│
│                               │  C 区   ││
│                               │ 房间   ││
│                               │ 场景   ││
│                               │ 虚拟人  ││
│                               │ 模型   ││
│                               └─────────┘│
│                                          │
└──────────────────────────────────────────┘
底部字幕条区 (1920×80)

分辨率: 1920×1080 (16:9)

A区（显示器）：
  - 整体框架: x=8, y=8, 宽=1364, 高=784
  - 屏幕区域: x=18, y=18, 宽=1344, 高=756 (精确16:9)
  - RGB灯条: y=772, 高=2
  - 底座&支架: y=772-827 (约55px物理占用)

B区（终端面板）：
  - 窗口背景: x=1380, y=8, 宽=532, 高=488
  - 标题栏: y=8-40, 高=32
  - 内容区: x=1385, y=45, 宽=522, 高=440
  - 状态栏: y=488-496

C区（房间场景）：
  - 位置: x=1380, y=504, 宽=532, 高=488
  - 装饰: LED灯带, 海报框, 桌面(键盘鼠标), 咖啡杯

底部字幕条：
  - 位置: y=1000, 宽=1920, 高=80

设计来源: frame-overlay.svg (1920×1080 标准画布)
```

### 2.2 各区域详解

#### **A 区 - 显示器（16:9 屏幕 + 底座）**

**用途**：显示 VLC 播放的歌曲/视频

**物理构成**：
- **显示器框架**：x=8, y=8, 宽=1364, 高=784（含窄边框）
- **屏幕显示区**：x=18, y=18, 宽=1344, 高=756（精确16:9，内容区）
- **RGB灯条**：y=772, 宽=1344, 高=2（显示器下方装饰）
- **底座&支架**：y=772-827（约55px，包括品牌区域和支架）

**关键坐标解析**：
```
y=0    ┌─┐
       │ │ ← 屏幕内容区起点 y=18
       │ │
y=18-774 └─┘ ← 屏幕显示区 (756px高)
       ═════ ← RGB灯条 y=772
y=772 [品牌 ] ← 显示器品牌区 y=786-796
       [支架 ] ← 显示器支架 y=792-827
y=827 └───┘
```

**内容来源**：
- 默认：通过 OBS WebSocket 控制 VLC 源，循环播放轮播目录中的视频
- 点歌时：自动设置 VLC 源播放列表为指定歌曲
- 支持带背景的音乐视频（如果有）

**配置方式**：

```
OBS 场景树:
MScreen (主场景)
└── [VLC 视频源] (名称: vlc_player)

VLC 视频源配置:
- 输入: 播放列表（由程序通过 WebSocket 自动设置）
- 分辨率: 1344×756 (精确16:9)
- 位置: x=18, y=18 (对应显示器屏幕区域)
- 循环播放: ✓ 启用
- 随机: ✓ 启用
```

**OBS 配置步骤**：

```
1. OBS → 工具 → WebSocket 服务器设置
   - 启用 WebSocket 服务器: ☑
   - 服务器端口: 4455
   - 启用身份验证: ☑
   - 设置密码（与 config.ini 中一致）

2. OBS → 场景 → [MScreen] → 右下"源" → [+] 添加
3. 选择 "VLC 视频源"
4. 配置：
   - 名称: vlc_player
   - 播放列表: 启用 ☑ (内容由程序自动管理)
   - 循环: ☑
   - 随机: ☑
5. 位置: x=18, y=18
6. 宽度: 1344, 高度: 756
7. [确定]
```

#### **B 区 - 终端面板（信息展示）**

**用途**：实时显示直播信息和系统状态，根据模式动态变化

**窗口结构**：
- **窗口总体**：x=1380, y=8, 宽=532, 高=488
- **标题栏**：y=8-40, 高=32（含窗口控制按钮和标题）
- **内容区**：x=1385, y=45, 宽=522, 高=440（面板动态内容）
- **状态栏**：y=488-496, 高=8（底部状态指示）

**设计特点**：
- 仿 macOS 终端窗口风格
- 三色窗口控制按钮（红/黄/绿）
- 标题：`bash — stream@cyber-station: ~/live`
- 内容区边框：#333 1px
- 假命令行装饰（静态）

**区域对齐**：
- 与 A 区顶部对齐，窗口从 y=8 开始
- 内容区从 y=45 开始（标题栏 + 分割线后）
- 底部与 C 区接壤（y=488 ~ y=504）

**显示内容**（根据模式）：

| 模式 | 显示内容 |
|------|---------|
| **直播模式** 🔴 | 直播标记、在线人数、运行时长、当前歌曲、时间 |
| **PK模式** ⚔️ | PK对手、比分、战况、当前歌曲 |
| **歌曲模式** 🎵 | 队列标记、当前歌曲、排队列表(4首)、请求提示 |
| **录像模式** 🎶 | 当前播放(大字)、下一首、队列预览、统计 |
| **回放模式** 📼 | 当前录播(大字)、点播队列(3个)、统计 |
| **空闲模式** 💬 | 欢迎信息、帮助提示、时间 |

**字体设置**（已优化适配 1080p 直播）：
- 标题(xl): 32px - 大标题
- 大文字(lg): 26px - 主要信息
- 正文(md): 20px - 内容文字
- 列表(sm): 17px - 队列列表
- 小字(xs): 14px - 提示和时间

**OBS 配置步骤**：

```
1. OBS → 场景 → [MScreen] → 右下"源" → [+] 添加
2. 选择 "图像" → 创建新的
3. 配置：
   - 名称: B区-终端面板
   - 文件: D:\SingllLive\data\panel.png
   - 位置: x=1385, y=45
   - 大小: 宽=522, 高=440
4. [确定]

面板通过 OBS WebSocket 自动刷新（每秒），无需额外脚本。
```

#### **C 区 - 房间场景（虚拟直播间）**

**用途**：显示虚拟直播间场景（Vtuber/虚拟人模型或房间环境）

**窗口结构**：
- **窗口总体**：x=1380, y=504, 宽=532, 高=488
- **标题栏**：无（房间场景无标题）
- **装饰元素**：
  - LED灯带（顶部）：y=514, 高=3
  - 海报框架（2个）：约 75×95px
  - 电脑桌：y=748, 宽=512, 高=112
  - 键盘：1:1 等比例渲染
  - 鼠标和鼠标垫
  - 咖啡杯（办公场景）

**设计特点**：
- 模拟直播间办公桌面景观
- RGB 灯效（键盘、鼠标、灯带）
- 两台显示器和一台笔记本的工作空间布局
- 暗黑极客风格，与 A 区显示器和 B 区终端风格统一

**使用方案**：

**方案 A：虚拟人模型（推荐）**

```
1. 先在 Windows 中启动 VTubeStudio
2. OBS → 场景 → [MScreen] → 右下"源" → [+] 添加
3. 选择 "窗口捕获"
4. 配置：
   - 名称: C区-虚拟直播间
   - 窗口: VTubeStudio
   - 位置: x=1380, y=504
   - 大小: 宽=532, 高=488
5. [确定]
```

**方案 B：OBS 场景嵌套**

```
1. 在 OBS 中新建嵌套场景: VirtualRoom
2. 可在其中添加：
   - 背景图片 (room_bg.png)
   - VTubeStudio 窗口捕获
   - 动画或动态元素
3. MScreen 中添加场景源：
   - 类型: 场景
   - 选择: VirtualRoom
   - 位置: x=1380, y=504
   - 大小: 宽=532, 高=488
```

**VTubeStudio 配置**（若使用）：

```
1. 下载安装 VTubeStudio (免费版)
2. 导入 Live2D 或 3D 模型
3. 配置虚拟人：
   - 表情: 根据模式设置（可选）
   - 背景: 透明背景
   - 分辨率: >= 1080p
4. 在 OBS 中窗口捕获到 C 区
```

### 2.3 背景、框架和底部字幕条

**背景图层**：使用 background.svg（渐变、光晕、网格、电路纹理）

```
OBS 配置:
1. MScreen 中添加图像源: background.png (或 SVG导出的PNG)
2. 位置: x=0, y=0
3. 大小: 1920×1080 (全屏)
4. 顺序: 放在最底层（在所有源之下）
```

**框架遮罩**：使用 frame-overlay.svg（显示器边框、窗口边框、装饰）

```
OBS 配置:
1. MScreen 中添加图像源: frame-overlay.png (或 SVG导出的PNG)
2. 位置: x=0, y=0
3. 大小: 1920×1080 (全屏)
4. 顺序: 放在最顶层（在所有源之上）
5. 说明: 此源仅提供视觉框架，不交互
```

**底部字幕条**（可选，集成在 frame-overlay 中）

```
位置: y=1000, 宽=1920, 高=80
用途: 显示标题、实时信息、命令行装饰等
设计: 终端风格，与整体视觉统一
```

**源层级顺序（从下到上）：**

```
1. background.png           ← 最底层（背景）
2. VLC视频源 (A区)         ← 左侧主内容
3. B区面板图像源           ← 右侧上方
4. C区房间/虚拟人          ← 右侧下方
5. frame-overlay.png        ← 最顶层（边框装饰）
```

---

### 2.4 OBS 配置快速参考表

| 源名称 | 类型 | 位置(x,y) | 大小(w×h) | 文件/输入 | 备注 |
|--------|------|-----------|----------|---------|------|
| **背景** | 图像 | 0,0 | 1920×1080 | background.png | 最底层 |
| **A区-VLC视频** | VLC源 | 18,18 | 1344×756 | vlc_player (WebSocket 控制) | 主内容区 |
| **B区-面板** | 图像 | 1385,45 | 522×440 | panel.png (WebSocket 刷新) | 自动刷新1秒 |
| **C区-虚拟人** | 窗口捕获/场景 | 1380,504 | 532×488 | VTubeStudio窗口 | 可选配置 |
| **框架遮罩** | 图像 | 0,0 | 1920×1080 | frame-overlay.png | 最顶层 |

### 2.5 设计文件来源

所有坐标和设计基于 `assets/designs/` 中的设计文件：

- **frame-overlay.svg**：精确的区域划分、显示器框架、窗口边框、装饰元素
- **background.svg**：渐变背景、网格、光晕、电路纹理、暗角效果

✨ **设计特点**：
- 显示器采用窄边框设计（8px）
- 终端窗口仿 macOS 风格
- 房间场景包含完整办公桌面
- RGB 灯效（键盘、鼠标、显示器、灯带）
- 黑客/极客主题视觉风格

---

## 三、快速开始

### 3.1 环境要求

- Windows 10/11 或 Linux
- Python 3.8+ (推荐 3.10+)
- OBS Studio 28+ (内置 WebSocket v5)
- B站账号（直播间号、SESSDATA、bili_jct）

### 3.2 安装步骤

```bash
# 1. 克隆或下载项目
git clone https://github.com/singll/SingllLive.git
cd SingllLive

# 2. 安装依赖
pip install -r requirements.txt

# 3. 复制并编辑配置文件
copy config\config.ini.example config.ini
# 或 Linux:
# cp config/config.ini.example config.ini

# 在编辑器中打开 config.ini，填入你的信息
```

### 3.3 配置文件模板

编辑 `config.ini`：

```ini
[bilibili]
# 从 B站直播间 URL 获取
room_id = 你的直播间号

# 从浏览器 Cookie 获取
uid = 你的B站UID
sessdata = SESSDATA值(url编码)
bili_jct = bili_jct值
buvid3 = buvid3值

[obs]
# OBS WebSocket v5 配置 (OBS Studio 28+ 内置)
host = localhost
port = 4455
password = 你的OBS_WebSocket密码

# OBS 场景和源名称
scene_name = AScreen
vlc_source = vlc_player
broadcast_source = broadcast_screen
panel_source = B区-终端面板

[paths]
# 歌曲库目录（MP3/FLAC/M4A/WAV等，点歌搜索的来源）
song_dir = D:\SingllLive\songs

# 录像目录（直播画面/视频，录像模式时播放）
playback_dir = D:\SingllLive\broadcast

# 录播目录（回放模式，文件名格式: YYYYMMDDNN.mp4）
replay_dir = D:\SingllLive\replay

# 运行时数据目录
data_dir = D:\SingllLive\data

[panel]
# 面板分辨率（与 OBS 中的设置一致）
width = 520
height = 435
refresh_interval = 1

[pk]
# PK 目标直播间号（可选）
target_room_id = 0
```

### 3.4 启动系统

```bash
# 方式 1: 直接运行（推荐）
python cyber_live.py

# 方式 2: Windows 批处理
start.bat

# 方式 3: 仅测试面板（不启动 VLC 和弹幕）
python cyber_live.py --panel-only
```

**预期输出**：

```
[14:24:06] main       已加载配置: config.ini
[14:24:06] main       歌曲库: 123 首 (来自: D:\SingllLive\songs)
[14:24:06] main       录播库: 15 个 (来自: D:\SingllLive\replay)
[14:24:06] main       模式管理器已初始化 (默认录像模式)
[14:24:07] obs        OBS WebSocket 已连接: localhost:4455
[14:24:07] obs        OBS 版本: 30.x.x
[14:24:08] mode       模式切换: 其他模式 → 录像模式 (原因: 系统启动)
[14:24:15] panel      面板渲染器启动 (间隔 1.0s)
[14:24:02] danmaku    弹幕机器人启动 (直播间 1847357920)
[14:24:06] main       =============================================
[14:24:06] main         程序员深夜电台 - 所有服务已启动
[14:24:06] main         OBS WebSocket: localhost:4455 (已连接)
[14:24:06] main         面板输出:  D:\SingllLive\data\panel.png
[14:24:06] main         歌曲数量:  123
[14:24:06] main         按 Ctrl+C 优雅退出
[14:24:06] main       =============================================
```

---

## 四、配置详解

### 4.1 获取 B站 Cookie

```
1. 打开 B站直播间: https://live.bilibili.com/你的直播间号
2. 按 F12 打开开发者工具
3. 切换到 "应用" 或 "Storage" 标签
4. 找到 "Cookies" → live.bilibili.com
5. 复制以下值到 config.ini:
   - SESSDATA → sessdata=
   - bili_jct → bili_jct=
   - buvid3 → buvid3=
6. 保存并重启程序
```

### 4.2 VLC 歌曲库组织

```
D:\SingllLive\songs\
├── 歌手名/
│   ├── 歌曲1.mp3
│   ├── 歌曲2.flac
│   └── ...
├── 翻唱/
│   ├── 千本樱.mp3
│   └── ...
└── ...

支持的格式:
- MP3, FLAC, WAV, M4A, OGG, etc.
```

### 4.3 OBS 场景导入脚本

为了方便，可以使用 OBS 的场景导入功能：

```
1. OBS → 场景集 → [右键] → 导入
2. 选择预设配置文件（如果提供）
3. 所有场景和源会自动配置
```

---

## 五、工作流程

### 5.1 播放控制生命周期（模式驱动）

```
启动 python cyber_live.py
    ↓
连接 OBS WebSocket v5
    ↓
系统进入录像模式 (VIDEO)
    ↓
通过 OBS WebSocket 设置 VLC 源播放列表 → 循环播放直播画面/视频
    ↓
用户点歌 → 自动切换到歌曲模式 (MUSIC)
    ↓
VLC 源播放点歌歌曲 → 面板显示队列列表
    ↓
队列播完 → 自动回到录像模式
    ↓
或用户发送"直播模式" → 切换到直播模式 (BROADCAST)
    ↓
VLC 源停止 → 面板显示直播信息 → 直播源显示
    ↓
直播结束 → 回到录像模式
```

### 5.2 弹幕命令列表

| 命令 | 格式 | 说明 | 冷却 |
|------|------|------|------|
| **点歌** | `点歌 歌名` | 搜索并播放歌曲 | 5秒 |
| **点播** | `点播 日期编号` | 播放指定录播 (如 `点播 2026013101`) | 5秒 |
| **切歌** | `切歌` / `切播` | 跳过当前歌曲/录播 | 10秒 |
| **当前** | `当前` | 查询当前播放歌曲 | 10秒 |
| **歌单** | `歌单` | 显示歌曲库列表(前5首) | 30秒 |
| **帮助** | `帮助` / `命令` | 显示所有支持的命令 | 5秒 |
| **直播模式** | `直播模式` | 切换到直播模式 | 3秒 |
| **PK模式** | `PK模式` | 切换到PK模式 | 3秒 |
| **歌曲模式** | `歌曲模式` | 切换到歌曲模式 | 3秒 |
| **录像模式** | `录像模式` | 切换到录像模式 | 3秒 |
| **回放模式** | `回放模式` | 切换到回放模式 | 3秒 |
| **其他模式** | `其他模式` | 切换到其他模式 | 3秒 |
| **查看模式** | `查看模式` | 显示当前模式 | 2秒 |

### 5.3 模式切换规则

```
所有模式之间可以自由切换，通过弹幕命令即可。
切换时自动保存当前模式播放进度，切回来后从断点恢复。

点歌行为：
- 直播模式下点歌 → 加入队列等待
- 其他模式下点歌 → 立即播放

点播行为：
- 发送"点播 YYYYMMDDNN" → 自动切换到回放模式
- 当前录播播完后播放点播的录播
```

---

## 六、故障排查

### 6.1 弹幕命令无响应

**症状**：发送命令后没有回复

**排查步骤**：

```
1. 检查日志中是否有：
   [14:24:02] danmaku  弹幕机器人启动 (直播间 1847357920)

2. 如果没有，检查 config.ini:
   - room_id 是否正确
   - sessdata / bili_jct 是否正确
   - 重启程序

3. 检查冷却时间：
   - 同一命令在冷却期内会被忽略
   - 等待冷却时间后重试

4. 尝试发送"帮助"命令，看是否有回复
```

### 6.2 VLC 源不播放

**症状**：OBS 中 VLC 源没有播放

**排查步骤**：

```
1. 检查 OBS WebSocket 连接：
   日志中应有：OBS WebSocket 已连接

2. 检查 OBS 中的 VLC 源名称：
   确保 config.ini 中的 vlc_source 与 OBS 中的源名称一致

3. 检查歌曲库：
   dir D:\SingllLive\songs
   （目录应该不为空）

4. 检查 OBS WebSocket 服务器：
   OBS → 工具 → WebSocket 服务器设置
   - 启用 WebSocket 服务器: ☑
   - 服务器端口: 4455
   - 启用身份验证: ☑ (密码与 config.ini 一致)

5. 检查 VLC 源配置：
   OBS 中的 VLC 源应设置为循环播放
```

### 6.3 面板不更新

**症状**：panel.png 文件没有变化

**排查步骤**：

```
1. 检查 OBS WebSocket 连接状态：
   面板通过 WebSocket 自动刷新，无需额外脚本
   日志中应有：面板渲染器启动

2. 检查面板文件是否存在：
   D:\SingllLive\data\panel.png
   （文件应该每秒更新）

3. 检查日志：
   [14:24:15] panel  面板渲染器启动 (间隔 1.0s)
```

### 6.4 点歌无法播放

**症状**：点歌命令有回复，但 VLC 没有播放歌曲

**排查步骤**：

```
1. 检查歌曲库中是否有该歌曲：
   发送 "歌单" 命令查看库中歌曲

2. 尝试用准确的歌曲名点歌：
   不要用模糊名称

3. 检查歌曲格式是否支持：
   支持: MP3, FLAC, WAV, M4A
   不支持: 某些加密或损坏的文件

4. 查看日志：
   [14:35:22] danmaku  [点歌] user: 歌名 -> 歌名
   如果显示 "未找到"，说明搜索失败
```

---

## 附录：快速参考

### 文件清单

| 文件 | 说明 |
|------|------|
| `cyber_live.py` | 主程序，启动所有服务 |
| `config.ini` | 配置文件，必须填写 |
| `modules/obs_control.py` | OBS WebSocket v5 控制器 |
| `modules/vlc_control.py` | VLC 源播放控制 (状态保存) |
| `modules/modes.py` | 模式管理系统 (6种模式) |
| `modules/danmaku.py` | 弹幕机器人 |
| `modules/panel.py` | 面板渲染器 |
| `modules/songs.py` | 歌曲库管理 |
| `modules/replay.py` | 录播回放管理 |

### 常用命令

```bash
# 启动系统
python cyber_live.py

# 启动并测试面板
python cyber_live.py --panel-only

# 安装依赖
pip install -r requirements.txt

# 查看日志（实时）
tail -f data/cyber_live.log
```

### 获取帮助

- **遇到问题**：查看日志文件
- **需要帮助**：在直播间发送"帮助"命令
- **代码问题**：查看 GitHub Issues
- **功能建议**：在 GitHub 提交 Issue 或 PR
